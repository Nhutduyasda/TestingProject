@model MyProject.Models.Shared.Combo

@{
    ViewData["Title"] = "Tạo Combo Mới";
}

<div class="max-w-5xl mx-auto">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Tạo Combo Mới</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400">Điền thông tin chi tiết để tạo gói combo mới</p>
        </div>
        <a asp-action="Index" class="flex items-center gap-2 px-4 py-2 text-gray-700 transition-colors bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-700">
            <i class="fas fa-arrow-left"></i>
            <span>Quay lại</span>
        </a>
    </div>

    <form asp-action="Create" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="mb-4 text-red-500"></div>

        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
            <!-- Main Info -->
            <div class="space-y-6 lg:col-span-2">
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Thông tin chung</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label asp-for="ComboName" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Tên Combo</label>
                            <input asp-for="ComboName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="Nhập tên combo..." />
                            <span asp-validation-for="ComboName" class="text-xs text-red-500"></span>
                        </div>

                        <div>
                            <label asp-for="Description" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Mô tả</label>
                            <textarea asp-for="Description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="Mô tả chi tiết về combo..."></textarea>
                            <span asp-validation-for="Description" class="text-xs text-red-500"></span>
                        </div>

                        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Giá gốc</label>
                                <div class="relative">
                                    <input id="OriginalPrice" type="text" class="w-full px-4 py-2 pl-10 bg-gray-100 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300" readonly value="0" />
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <span class="text-gray-500 dark:text-gray-400">₫</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Giảm giá</label>
                                <select id="DiscountSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" onchange="calculatePrice()">
                                    <option value="0">Không giảm giá</option>
                                    <option value="10">10%</option>
                                    <option value="15">15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                    <option value="30">30%</option>
                                    <option value="custom">Tùy chỉnh</option>
                                </select>
                            </div>

                            <div>
                                <label asp-for="Price" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Giá bán (VNĐ)</label>
                                <div class="relative">
                                    <input asp-for="Price" type="number" step="1000" class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="0" />
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <span class="text-gray-500 dark:text-gray-400">₫</span>
                                    </div>
                                </div>
                                <span asp-validation-for="Price" class="text-xs text-red-500"></span>
                            </div>

                            <div>
                                <label asp-for="CategoryId" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Danh mục</label>
                                <select asp-for="CategoryId" asp-items="ViewBag.Categories" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                                    <option value="">-- Chọn danh mục --</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-xs text-red-500"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Selection -->
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Sản phẩm trong Combo</h3>
                        <div class="relative w-64">
                            <input type="text" id="productSearch" placeholder="Tìm kiếm sản phẩm..." class="w-full px-4 py-2 pl-10 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" onkeyup="filterProducts()" />
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="text-gray-400 fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div id="productsGrid" class="flex flex-col space-y-2 max-h-[600px] overflow-y-auto p-1 custom-scrollbar">
                        <!-- Dynamic product rows will be added here -->
                    </div>
                    
                    <div id="noProductsFound" class="hidden py-8 text-center text-gray-500">
                        <i class="mb-2 text-3xl fas fa-box-open"></i>
                        <p>Không tìm thấy sản phẩm nào</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar Info -->
            <div class="space-y-6">
                <!-- Status & Inventory -->
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Trạng thái & Kho</h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
                            <input asp-for="IsActive" type="checkbox" class="w-5 h-5 text-brand-600 border-gray-300 rounded focus:ring-brand-500 dark:bg-gray-700 dark:border-gray-600" />
                            <label asp-for="IsActive" class="text-sm font-medium text-gray-700 dark:text-gray-300">Đang hoạt động</label>
                        </div>

                        <div>
                            <label asp-for="AvailableQuantity" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Số lượng có sẵn</label>
                            <input asp-for="AvailableQuantity" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="Không giới hạn nếu để trống" />
                            <span asp-validation-for="AvailableQuantity" class="text-xs text-red-500"></span>
                        </div>
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Hình ảnh</h3>
                    
                    <div class="space-y-4">
                        <div class="relative w-full aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-dashed border-gray-300 dark:bg-gray-800 dark:border-gray-700 flex items-center justify-center group">
                            <img id="imagePreview" src="#" alt="Preview" class="absolute inset-0 object-cover w-full h-full hidden" />
                            <div class="text-center p-4" id="uploadPlaceholder">
                                <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Click để tải ảnh lên</p>
                            </div>
                            <input type="file" name="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(this)" accept="image/*" />
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center">Định dạng: JPG, PNG, GIF. Tối đa 5MB.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-end gap-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-800">
            <a asp-action="Index" class="px-6 py-2.5 text-sm font-medium text-gray-700 transition-colors bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-700">
                Hủy bỏ
            </a>
            <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white transition-colors bg-brand-600 rounded-lg hover:bg-brand-700 focus:ring-4 focus:ring-brand-500/20">
                <i class="mr-2 fas fa-save"></i> Tạo Combo
            </button>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        var allProducts = @Html.Raw(Json.Serialize(ViewBag.Products));
        var allVariants = [];

        // Flatten products to variants
        allProducts.forEach(p => {
            if (p.variants && p.variants.length > 0) {
                p.variants.forEach(v => {
                    allVariants.push({
                        variantId: v.variantId,
                        variantName: v.variantName,
                        price: v.price,
                        productName: p.name,
                        imageUrl: p.imageUrl,
                        productId: p.productId
                    });
                });
            }
        });

        function renderProducts() {
            var container = $('#productsGrid');
            container.empty();
            
            allVariants.forEach(function(v) {
                var priceFormatted = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(v.price);
                var displayName = `${v.productName} - ${v.variantName}`;
                
                var html = `
                    <div class="flex items-center justify-between p-3 transition-colors border border-gray-200 rounded-lg hover:bg-gray-50 dark:border-gray-700 dark:hover:bg-gray-800 product-row group" data-name="${displayName.toLowerCase()}">
                        <div class="flex items-center gap-4">
                            <!-- Image -->
                            <div class="flex-shrink-0 w-12 h-12 overflow-hidden bg-gray-100 rounded-md dark:bg-gray-700">
                                <img src="${v.imageUrl}" alt="${displayName}" class="object-cover w-full h-full" onerror="this.src='/images/default-product.png'" />
                            </div>
                            
                            <!-- Info -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-900 dark:text-white" title="${displayName}">${displayName}</h4>
                                <p class="text-sm font-bold text-brand-600 dark:text-brand-400">${priceFormatted}</p>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex items-center gap-3">
                            <!-- Quantity Control (Hidden by default) -->
                            <div class="items-center hidden gap-2 quantity-control" id="qty-control-${v.variantId}">
                                <span class="text-xs text-gray-500">SL:</span>
                                <input type="number" name="quantities" value="1" min="1" 
                                       class="w-16 px-2 py-1 text-sm text-center border border-gray-300 rounded focus:ring-1 focus:ring-brand-500 dark:bg-gray-900 dark:border-gray-600 dark:text-white" 
                                       onchange="calculatePrice()" onkeyup="calculatePrice()" disabled />
                            </div>

                            <!-- Hidden Checkbox for Form Submission -->
                            <input type="checkbox" name="variantIds" value="${v.variantId}" class="hidden product-checkbox" />

                            <!-- Toggle Button -->
                            <button type="button" onclick="toggleProduct(this, ${v.variantId})" 
                                    class="flex items-center justify-center w-8 h-8 transition-colors rounded-full bg-gray-100 text-gray-500 hover:bg-brand-100 hover:text-brand-600 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-brand-900/30 dark:hover:text-brand-400 toggle-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.append(html);
            });
        }

        function toggleProduct(btn, variantId) {
            var row = $(btn).closest('.product-row');
            var checkbox = row.find('.product-checkbox');
            var qtyControl = $(`#qty-control-${variantId}`);
            var qtyInput = qtyControl.find('input');
            var icon = $(btn).find('i');
            
            // Toggle checkbox state
            var isChecked = !checkbox.prop('checked');
            checkbox.prop('checked', isChecked);
            
            if (isChecked) {
                // Selected State
                qtyControl.removeClass('hidden').addClass('flex');
                qtyInput.prop('disabled', false);
                
                $(btn).removeClass('bg-gray-100 text-gray-500 hover:bg-brand-100 hover:text-brand-600')
                      .addClass('bg-brand-600 text-white hover:bg-red-600 hover:text-white');
                
                icon.removeClass('fa-plus').addClass('fa-check');
                
                // Add hover effect to show delete icon
                $(btn).hover(
                    function() { $(this).find('i').removeClass('fa-check').addClass('fa-times'); },
                    function() { $(this).find('i').removeClass('fa-times').addClass('fa-check'); }
                );
                
                row.addClass('border-brand-500 bg-brand-50/30 dark:bg-brand-900/10');
            } else {
                // Deselected State
                qtyControl.addClass('hidden').removeClass('flex');
                qtyInput.prop('disabled', true);
                qtyInput.val(1); // Reset quantity
                
                $(btn).addClass('bg-gray-100 text-gray-500 hover:bg-brand-100 hover:text-brand-600')
                      .removeClass('bg-brand-600 text-white hover:bg-red-600 hover:text-white');
                
                icon.removeClass('fa-check fa-times').addClass('fa-plus');
                
                // Remove hover effect
                $(btn).off('mouseenter mouseleave');
                
                row.removeClass('border-brand-500 bg-brand-50/30 dark:bg-brand-900/10');
            }
            
            calculatePrice();
        }

        function filterProducts() {
            var term = $('#productSearch').val().toLowerCase();
            var hasVisible = false;
            
            $('.product-row').each(function() {
                var name = $(this).data('name');
                if (name.includes(term)) {
                    $(this).removeClass('hidden').addClass('flex');
                    hasVisible = true;
                } else {
                    $(this).addClass('hidden').removeClass('flex');
                }
            });
            
            if (!hasVisible) {
                $('#noProductsFound').removeClass('hidden');
            } else {
                $('#noProductsFound').addClass('hidden');
            }
        }

        function calculatePrice() {
            var totalOriginal = 0;
            
            $('.product-checkbox:checked').each(function() {
                var variantId = $(this).val();
                var variant = allVariants.find(v => v.variantId == variantId);
                
                if (variant) {
                    var qtyInput = $(`#qty-control-${variantId} input`);
                    var quantity = parseInt(qtyInput.val()) || 0;
                    totalOriginal += variant.price * quantity;
                }
            });

            // Update Original Price display
            $('#OriginalPrice').val(new Intl.NumberFormat('vi-VN').format(totalOriginal));

            // Calculate Discounted Price
            var discountType = $('#DiscountSelect').val();
            var finalPrice = totalOriginal;

            if (discountType !== 'custom') {
                var discountPercent = parseFloat(discountType);
                finalPrice = totalOriginal * (1 - discountPercent / 100);
                $('#Price').val(finalPrice);
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#imagePreview').attr('src', e.target.result).removeClass('hidden');
                    $('#uploadPlaceholder').addClass('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Initialize
        $(document).ready(function() {
            renderProducts();
        });
    </script>
}
