@model MyProject.Models.Shared.Combo

@{
    ViewData["Title"] = "Chỉnh sửa Combo";
}

<div class="max-w-5xl mx-auto">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Chỉnh sửa Combo</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400">Cập nhật thông tin gói combo #@Model.ComboId</p>
        </div>
        <a asp-action="Index" class="flex items-center gap-2 px-4 py-2 text-gray-700 transition-colors bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-700">
            <i class="fas fa-arrow-left"></i>
            <span>Quay lại</span>
        </a>
    </div>

    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="mb-4 text-red-500"></div>
        <input type="hidden" asp-for="ComboId" />

        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
            <!-- Main Info -->
            <div class="space-y-6 lg:col-span-2">
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Thông tin chung</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label asp-for="ComboName" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Tên Combo</label>
                            <input asp-for="ComboName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" />
                            <span asp-validation-for="ComboName" class="text-xs text-red-500"></span>
                        </div>

                        <div>
                            <label asp-for="Description" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Mô tả</label>
                            <textarea asp-for="Description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white"></textarea>
                            <span asp-validation-for="Description" class="text-xs text-red-500"></span>
                        </div>

                        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Giá gốc (Tự động tính)</label>
                                <div class="relative">
                                    <input id="OriginalPrice" type="text" class="w-full px-4 py-2 pl-10 bg-gray-100 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300" readonly value="0" />
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <span class="text-gray-500 dark:text-gray-400">₫</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Giảm giá</label>
                                <select id="DiscountSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" onchange="calculatePrice()">
                                    <option value="custom">Tùy chỉnh (Hiện tại)</option>
                                    <option value="0">Không giảm giá</option>
                                    <option value="10">10%</option>
                                    <option value="15">15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                    <option value="30">30%</option>
                                </select>
                            </div>

                            <div>
                                <label asp-for="Price" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Giá bán (VNĐ)</label>
                                <div class="relative">
                                    <input asp-for="Price" type="number" step="1000" class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" />
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <span class="text-gray-500 dark:text-gray-400">₫</span>
                                    </div>
                                </div>
                                <span asp-validation-for="Price" class="text-xs text-red-500"></span>
                            </div>

                            <div>
                                <label asp-for="CategoryId" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Danh mục</label>
                                <select asp-for="CategoryId" asp-items="ViewBag.Categories" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                                    <option value="">-- Chọn danh mục --</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-xs text-red-500"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Selection -->
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Sản phẩm trong Combo</h3>
                        <div class="relative w-64">
                            <input type="text" id="productSearch" placeholder="Tìm kiếm sản phẩm..." class="w-full px-4 py-2 pl-10 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" onkeyup="filterProducts()" />
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="text-gray-400 fas fa-search"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div id="productsGrid" class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-3 xl:grid-cols-4 max-h-[600px] overflow-y-auto p-1">
                        <!-- Dynamic product cards will be added here -->
                    </div>
                    
                    <div id="noProductsFound" class="hidden py-8 text-center text-gray-500">
                        <i class="mb-2 text-3xl fas fa-box-open"></i>
                        <p>Không tìm thấy sản phẩm nào</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar Info -->
            <div class="space-y-6">
                <!-- Status & Inventory -->
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Trạng thái & Kho</h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
                            <input asp-for="IsActive" type="checkbox" class="w-5 h-5 text-brand-600 border-gray-300 rounded focus:ring-brand-500 dark:bg-gray-700 dark:border-gray-600" />
                            <label asp-for="IsActive" class="text-sm font-medium text-gray-700 dark:text-gray-300">Đang hoạt động</label>
                        </div>

                        <div>
                            <label asp-for="AvailableQuantity" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Số lượng có sẵn</label>
                            <input asp-for="AvailableQuantity" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" />
                            <span asp-validation-for="AvailableQuantity" class="text-xs text-red-500"></span>
                        </div>
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Hình ảnh</h3>
                    
                    <div class="space-y-4">
                        <div class="relative w-full aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-dashed border-gray-300 dark:bg-gray-800 dark:border-gray-700 flex items-center justify-center group">
                            @if (!string.IsNullOrEmpty(Model.ImageUrl))
                            {
                                <img id="imagePreview" src="@Model.ImageUrl" alt="Preview" class="absolute inset-0 object-cover w-full h-full" />
                                <div class="text-center p-4 hidden" id="uploadPlaceholder">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Click để tải ảnh lên</p>
                                </div>
                            }
                            else
                            {
                                <img id="imagePreview" src="#" alt="Preview" class="absolute inset-0 object-cover w-full h-full hidden" />
                                <div class="text-center p-4" id="uploadPlaceholder">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Click để tải ảnh lên</p>
                                </div>
                            }
                            <input type="file" name="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(this)" accept="image/*" />
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center">Định dạng: JPG, PNG, GIF. Tối đa 5MB.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-end gap-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-800">
            <a asp-action="Index" class="px-6 py-2.5 text-sm font-medium text-gray-700 transition-colors bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-700">
                Hủy bỏ
            </a>
            <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white transition-colors bg-brand-600 rounded-lg hover:bg-brand-700 focus:ring-4 focus:ring-brand-500/20">
                <i class="mr-2 fas fa-save"></i> Lưu thay đổi
            </button>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        var allProducts = @Html.Raw(Json.Serialize(ViewBag.Products));
        var existingComboProducts = @Html.Raw(Json.Serialize(Model.ComboProducts.Select(cp => new { variantId = cp.VariantId, quantity = cp.Quantity })));
        var allVariants = [];

        // Flatten products to variants
        allProducts.forEach(p => {
            if (p.variants && p.variants.length > 0) {
                p.variants.forEach(v => {
                    allVariants.push({
                        variantId: v.variantId,
                        variantName: v.variantName,
                        price: v.price,
                        productName: p.name,
                        imageUrl: p.imageUrl,
                        productId: p.productId
                    });
                });
            }
        });

        function renderProducts() {
            var container = $('#productsGrid');
            container.empty();
            
            allVariants.forEach(function(v) {
                var priceFormatted = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(v.price);
                var displayName = `${v.productName} - ${v.variantName}`;
                
                // Check if this variant is selected
                var existing = existingComboProducts.find(cp => cp.variantId == v.variantId);
                var isSelected = !!existing;
                var quantity = existing ? existing.quantity : 1;
                
                var html = `
                    <div class="relative overflow-hidden transition-all border border-gray-200 rounded-lg group hover:shadow-md dark:border-gray-700 dark:bg-gray-800 product-card ${isSelected ? 'ring-1 ring-brand-500' : ''}" data-name="${displayName.toLowerCase()}">
                        <div class="absolute top-2 right-2 z-10">
                            <input type="checkbox" name="variantIds" value="${v.variantId}" class="w-5 h-5 text-brand-600 border-gray-300 rounded focus:ring-brand-500 dark:bg-gray-700 dark:border-gray-600 product-checkbox" onchange="toggleProduct(this, ${v.variantId}, ${v.price})" ${isSelected ? 'checked' : ''} />
                        </div>
                        
                        <div class="aspect-square bg-gray-100 dark:bg-gray-700">
                            <img src="${v.imageUrl}" alt="${displayName}" class="object-cover w-full h-full" onerror="this.src='/images/default-product.png'" />
                        </div>
                        
                        <div class="p-3">
                            <h4 class="mb-1 text-sm font-medium text-gray-900 line-clamp-2 dark:text-white" title="${displayName}">${displayName}</h4>
                            <p class="text-sm font-bold text-brand-600 dark:text-brand-400">${priceFormatted}</p>
                            
                            <div class="mt-3 quantity-control ${isSelected ? '' : 'hidden'}" id="qty-control-${v.variantId}">
                                <label class="block mb-1 text-xs text-gray-500">Số lượng</label>
                                <input type="number" name="quantities" value="${quantity}" min="1" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-brand-500 dark:bg-gray-900 dark:border-gray-600 dark:text-white" onchange="calculatePrice()" onkeyup="calculatePrice()" ${isSelected ? '' : 'disabled'} />
                            </div>
                        </div>
                        
                        <!-- Selected Overlay -->
                        <div class="absolute inset-0 border-2 border-brand-500 rounded-lg pointer-events-none ${isSelected ? '' : 'opacity-0'} product-overlay" id="overlay-${v.variantId}"></div>
                    </div>
                `;
                container.append(html);
            });
        }

        function toggleProduct(checkbox, variantId, price) {
            var card = $(checkbox).closest('.product-card');
            var qtyControl = $(`#qty-control-${variantId}`);
            var qtyInput = qtyControl.find('input');
            var overlay = $(`#overlay-${variantId}`);
            
            if (checkbox.checked) {
                qtyControl.removeClass('hidden');
                qtyInput.prop('disabled', false);
                overlay.removeClass('opacity-0');
                card.addClass('ring-1 ring-brand-500');
            } else {
                qtyControl.addClass('hidden');
                qtyInput.prop('disabled', true);
                qtyInput.val(1); // Reset quantity
                overlay.addClass('opacity-0');
                card.removeClass('ring-1 ring-brand-500');
            }
            
            calculatePrice();
        }

        function filterProducts() {
            var term = $('#productSearch').val().toLowerCase();
            var hasVisible = false;
            
            $('.product-card').each(function() {
                var name = $(this).data('name');
                if (name.includes(term)) {
                    $(this).removeClass('hidden');
                    hasVisible = true;
                } else {
                    $(this).addClass('hidden');
                }
            });
            
            if (!hasVisible) {
                $('#noProductsFound').removeClass('hidden');
            } else {
                $('#noProductsFound').addClass('hidden');
            }
        }

        function calculatePrice() {
            var totalOriginal = 0;
            
            $('.product-checkbox:checked').each(function() {
                var variantId = $(this).val();
                var variant = allVariants.find(v => v.variantId == variantId);
                
                if (variant) {
                    var qtyInput = $(`#qty-control-${variantId} input`);
                    var quantity = parseInt(qtyInput.val()) || 0;
                    totalOriginal += variant.price * quantity;
                }
            });

            // Update Original Price display
            $('#OriginalPrice').val(new Intl.NumberFormat('vi-VN').format(totalOriginal));

            // Calculate Discounted Price
            // Note: For Edit, we might want to keep the manually entered price or recalculate.
            // But the requirement is to calculate based on discount.
            // If the user manually changed the price, we might overwrite it here if they change products.
            // For now, let's stick to the logic: Original Price is sum of products.
            // Sale Price is manually entered, but if discount is selected, it auto-updates.
            
            var discountType = $('#DiscountSelect').val();
            if (discountType !== 'custom') {
                var discountPercent = parseFloat(discountType);
                var finalPrice = totalOriginal * (1 - discountPercent / 100);
                $('#Price').val(finalPrice);
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#imagePreview').attr('src', e.target.result).removeClass('hidden');
                    $('#uploadPlaceholder').addClass('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Initialize
        $(document).ready(function() {
            renderProducts();
            calculatePrice();
        });
    </script>
}
