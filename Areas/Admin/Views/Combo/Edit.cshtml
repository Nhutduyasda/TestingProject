@model MyProject.Models.Shared.Combo

@{
    ViewData["Title"] = "Chỉnh sửa Combo";
}

<div class="max-w-5xl mx-auto">
    <!-- Page Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Chỉnh sửa Combo</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400">Cập nhật thông tin gói combo #@Model.ComboId</p>
        </div>
        <a asp-action="Index" class="flex items-center gap-2 px-4 py-2 text-gray-700 transition-colors bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-700">
            <i class="fas fa-arrow-left"></i>
            <span>Quay lại</span>
        </a>
    </div>

    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="ModelOnly" class="mb-4 text-red-500"></div>
        <input type="hidden" asp-for="ComboId" />

        <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
            <!-- Main Info -->
            <div class="space-y-6 lg:col-span-2">
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Thông tin chung</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label asp-for="ComboName" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Tên Combo</label>
                            <input asp-for="ComboName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" />
                            <span asp-validation-for="ComboName" class="text-xs text-red-500"></span>
                        </div>

                        <div>
                            <label asp-for="Description" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Mô tả</label>
                            <textarea asp-for="Description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white"></textarea>
                            <span asp-validation-for="Description" class="text-xs text-red-500"></span>
                        </div>

                        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Giá gốc (Tự động tính)</label>
                                <div class="relative">
                                    <input id="OriginalPrice" type="text" class="w-full px-4 py-2 pl-10 bg-gray-100 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300" readonly value="0" />
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <span class="text-gray-500 dark:text-gray-400">₫</span>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Giảm giá</label>
                                <select id="DiscountSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" onchange="calculatePrice()">
                                    <option value="custom">Tùy chỉnh (Hiện tại)</option>
                                    <option value="0">Không giảm giá</option>
                                    <option value="10">10%</option>
                                    <option value="15">15%</option>
                                    <option value="20">20%</option>
                                    <option value="25">25%</option>
                                    <option value="30">30%</option>
                                </select>
                            </div>

                            <div>
                                <label asp-for="Price" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Giá bán (VNĐ)</label>
                                <div class="relative">
                                    <input asp-for="Price" type="number" step="1000" class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" />
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <span class="text-gray-500 dark:text-gray-400">₫</span>
                                    </div>
                                </div>
                                <span asp-validation-for="Price" class="text-xs text-red-500"></span>
                            </div>

                            <div>
                                <label asp-for="CategoryId" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Danh mục</label>
                                <select asp-for="CategoryId" asp-items="ViewBag.Categories" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                                    <option value="">-- Chọn danh mục --</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-xs text-red-500"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Selection -->
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Sản phẩm trong Combo</h3>
                        <button type="button" onclick="addProductRow()" class="px-3 py-1.5 text-sm font-medium text-brand-600 bg-brand-50 rounded-lg hover:bg-brand-100 dark:bg-brand-900/30 dark:text-brand-400 dark:hover:bg-brand-900/50 transition-colors">
                            <i class="mr-1 fas fa-plus"></i> Thêm sản phẩm
                        </button>
                    </div>
                    
                    <div id="productsContainer" class="space-y-3">
                        <!-- Dynamic product rows will be added here -->
                        @foreach (var item in Model.ComboProducts)
                        {
                            <div class="flex items-start gap-3 p-3 border border-gray-200 rounded-lg bg-gray-50 product-row dark:bg-gray-800 dark:border-gray-700">
                                <div class="flex-1">
                                    <label class="block mb-1 text-xs font-medium text-gray-500 uppercase dark:text-gray-400">Sản phẩm</label>
                                    <select name="productIds" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-900 dark:border-gray-600 dark:text-white" required onchange="calculatePrice()">
                                        @foreach (var product in ViewBag.Products)
                                        {
                                            var pId = product.GetType().GetProperty("ProductId").GetValue(product, null);
                                            var pName = product.GetType().GetProperty("Name").GetValue(product, null);
                                            var pPrice = product.GetType().GetProperty("Price").GetValue(product, null);

                                            if (pId.ToString() == item.ProductId.ToString())
                                            {
                                                <option value="@pId" data-price="@pPrice" selected>@pName</option>
                                            }
                                            else
                                            {
                                                <option value="@pId" data-price="@pPrice">@pName</option>
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="w-32">
                                    <label class="block mb-1 text-xs font-medium text-gray-500 uppercase dark:text-gray-400">Số lượng</label>
                                    <input type="number" name="quantities" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-900 dark:border-gray-600 dark:text-white" value="@item.Quantity" min="1" required onchange="calculatePrice()" onkeyup="calculatePrice()" />
                                </div>
                                <div class="pt-5">
                                    <button type="button" class="p-2 text-red-500 transition-colors rounded-lg hover:bg-red-50 hover:text-red-700 dark:hover:bg-red-900/20" onclick="removeProductRow(this)" title="Xóa dòng">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Sidebar Info -->
            <div class="space-y-6">
                <!-- Status & Inventory -->
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Trạng thái & Kho</h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-700">
                            <input asp-for="IsActive" type="checkbox" class="w-5 h-5 text-brand-600 border-gray-300 rounded focus:ring-brand-500 dark:bg-gray-700 dark:border-gray-600" />
                            <label asp-for="IsActive" class="text-sm font-medium text-gray-700 dark:text-gray-300">Đang hoạt động</label>
                        </div>

                        <div>
                            <label asp-for="AvailableQuantity" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Số lượng có sẵn</label>
                            <input asp-for="AvailableQuantity" type="number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" />
                            <span asp-validation-for="AvailableQuantity" class="text-xs text-red-500"></span>
                        </div>
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="p-6 bg-white border border-gray-200 shadow-sm rounded-xl dark:bg-gray-900 dark:border-gray-800">
                    <h3 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Hình ảnh</h3>
                    
                    <div class="space-y-4">
                        <div class="relative w-full aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-dashed border-gray-300 dark:bg-gray-800 dark:border-gray-700 flex items-center justify-center group">
                            @if (!string.IsNullOrEmpty(Model.ImageUrl))
                            {
                                <img id="imagePreview" src="@Model.ImageUrl" alt="Preview" class="absolute inset-0 object-cover w-full h-full" />
                                <div class="text-center p-4 hidden" id="uploadPlaceholder">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Click để tải ảnh lên</p>
                                </div>
                            }
                            else
                            {
                                <img id="imagePreview" src="#" alt="Preview" class="absolute inset-0 object-cover w-full h-full hidden" />
                                <div class="text-center p-4" id="uploadPlaceholder">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Click để tải ảnh lên</p>
                                </div>
                            }
                            <input type="file" name="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(this)" accept="image/*" />
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center">Định dạng: JPG, PNG, GIF. Tối đa 5MB.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex items-center justify-end gap-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-800">
            <a asp-action="Index" class="px-6 py-2.5 text-sm font-medium text-gray-700 transition-colors bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-700">
                Hủy bỏ
            </a>
            <button type="submit" class="px-6 py-2.5 text-sm font-medium text-white transition-colors bg-brand-600 rounded-lg hover:bg-brand-700 focus:ring-4 focus:ring-brand-500/20">
                <i class="mr-2 fas fa-save"></i> Lưu thay đổi
            </button>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        function previewImage(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#imagePreview').attr('src', e.target.result).removeClass('hidden');
                    $('#uploadPlaceholder').addClass('hidden');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function addProductRow() {
            var products = @Html.Raw(Json.Serialize(ViewBag.Products));
            
            var options = '<option value="" data-price="0">-- Chọn sản phẩm --</option>';
            products.forEach(function(p) {
                options += `<option value="${p.productId}" data-price="${p.price}">${p.name}</option>`;
            });

            var html = `
                <div class="flex items-start gap-3 p-3 border border-gray-200 rounded-lg bg-gray-50 product-row dark:bg-gray-800 dark:border-gray-700">
                    <div class="flex-1">
                        <label class="block mb-1 text-xs font-medium text-gray-500 uppercase dark:text-gray-400">Sản phẩm</label>
                        <select name="productIds" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-900 dark:border-gray-600 dark:text-white" required onchange="calculatePrice()">
                            ${options}
                        </select>
                    </div>
                    <div class="w-32">
                        <label class="block mb-1 text-xs font-medium text-gray-500 uppercase dark:text-gray-400">Số lượng</label>
                        <input type="number" name="quantities" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-900 dark:border-gray-600 dark:text-white" value="1" min="1" required onchange="calculatePrice()" onkeyup="calculatePrice()" />
                    </div>
                    <div class="pt-5">
                        <button type="button" class="p-2 text-red-500 transition-colors rounded-lg hover:bg-red-50 hover:text-red-700 dark:hover:bg-red-900/20" onclick="removeProductRow(this)" title="Xóa dòng">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `;
            
            $('#productsContainer').append(html);
        }

        function removeProductRow(btn) {
            $(btn).closest('.product-row').remove();
            calculatePrice();
        }

        function calculatePrice() {
            var totalOriginal = 0;
            
            $('.product-row').each(function() {
                var select = $(this).find('select[name="productIds"]');
                var quantityInput = $(this).find('input[name="quantities"]');
                
                var price = parseFloat(select.find(':selected').data('price')) || 0;
                var quantity = parseInt(quantityInput.val()) || 0;
                
                totalOriginal += price * quantity;
            });

            // Update Original Price display
            $('#OriginalPrice').val(new Intl.NumberFormat('vi-VN').format(totalOriginal));

            // Calculate Discounted Price
            var discountType = $('#DiscountSelect').val();
            var finalPrice = totalOriginal;

            if (discountType !== 'custom') {
                var discountPercent = parseFloat(discountType);
                finalPrice = totalOriginal * (1 - discountPercent / 100);
                $('#Price').val(finalPrice);
            }
        }

        // Initialize price on load
        $(document).ready(function() {
            calculatePrice();
        });
    </script>
}
