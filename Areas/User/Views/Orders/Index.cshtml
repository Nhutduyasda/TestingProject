@model IEnumerable<MyProject.Areas.User.Models.Invoice>
@using MyProject.Areas.Admin.Models

@{
    ViewData["Title"] = "Đơn hàng của tôi";
}

<!-- Page Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
        <i class="mr-2 fas fa-receipt text-brand-600"></i>
        Đơn hàng của tôi
    </h1>
    <p class="mt-2 text-gray-600 dark:text-gray-400">
        Theo dõi và quản lý tất cả đơn hàng của bạn
    </p>
</div>

<!-- Filter Tabs -->
<div class="mb-6">
    <div class="flex flex-wrap gap-2">
        <a asp-action="Index" class="px-4 py-2 text-sm font-medium @(string.IsNullOrEmpty(ViewBag.CurrentStatus) ? "text-white bg-brand-600 hover:bg-brand-700" : "text-gray-700 bg-white border border-gray-200 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800") transition-colors rounded-lg">
            <i class="mr-1 fas fa-list"></i> Tất cả
        </a>
        <a asp-action="Index" asp-route-status="Pending" class="px-4 py-2 text-sm font-medium @(ViewBag.CurrentStatus == "Pending" ? "text-white bg-brand-600 hover:bg-brand-700" : "text-gray-700 bg-white border border-gray-200 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800") transition-colors rounded-lg">
            <i class="mr-1 fas fa-clock"></i> Chờ xác nhận
        </a>
        <a asp-action="Index" asp-route-status="Confirmed" class="px-4 py-2 text-sm font-medium @(ViewBag.CurrentStatus == "Confirmed" ? "text-white bg-brand-600 hover:bg-brand-700" : "text-gray-700 bg-white border border-gray-200 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800") transition-colors rounded-lg">
            <i class="mr-1 fas fa-check-circle"></i> Đã xác nhận
        </a>
        <a asp-action="Index" asp-route-status="Shipped" class="px-4 py-2 text-sm font-medium @(ViewBag.CurrentStatus == "Shipped" ? "text-white bg-brand-600 hover:bg-brand-700" : "text-gray-700 bg-white border border-gray-200 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800") transition-colors rounded-lg">
            <i class="mr-1 fas fa-truck"></i> Đang giao
        </a>
        <a asp-action="Index" asp-route-status="Completed" class="px-4 py-2 text-sm font-medium @(ViewBag.CurrentStatus == "Completed" ? "text-white bg-brand-600 hover:bg-brand-700" : "text-gray-700 bg-white border border-gray-200 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800") transition-colors rounded-lg">
            <i class="mr-1 fas fa-check-double"></i> Hoàn thành
        </a>
        <a asp-action="Index" asp-route-status="Cancelled" class="px-4 py-2 text-sm font-medium @(ViewBag.CurrentStatus == "Cancelled" ? "text-white bg-brand-600 hover:bg-brand-700" : "text-gray-700 bg-white border border-gray-200 hover:bg-gray-50 dark:bg-gray-900 dark:border-gray-700 dark:text-gray-300 dark:hover:bg-gray-800") transition-colors rounded-lg">
            <i class="mr-1 fas fa-ban"></i> Đã hủy
        </a>
    </div>
</div>

<!-- Orders List -->
<div class="space-y-4">
    @if (Model?.Any() == true)
    {
        @foreach (var order in Model)
        {
            var statusClass = order.Status switch
            {
                OrderStatus.Pending => "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400",
                OrderStatus.Confirmed => "bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400",
                OrderStatus.Shipped => "bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-400",
                OrderStatus.Completed => "bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400",
                OrderStatus.CancelRequested => "bg-orange-100 text-orange-800 dark:bg-orange-900/20 dark:text-orange-400",
                OrderStatus.Cancelled => "bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400",
                _ => "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400"
            };
            
            var statusText = order.Status switch
            {
                OrderStatus.Pending => "Chờ xác nhận",
                OrderStatus.Confirmed => "Đã xác nhận",
                OrderStatus.Shipped => "Đang giao",
                OrderStatus.Completed => "Hoàn thành",
                OrderStatus.CancelRequested => "Yêu cầu hủy",
                OrderStatus.Cancelled => "Đã hủy",
                _ => order.Status.ToString()
            };
            
            <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-900 dark:border-gray-800">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                                Đơn hàng #@order.InvoiceId
                            </h3>
                            <span class="px-3 py-1 text-xs font-medium rounded-full @statusClass">
                                @statusText
                            </span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            <i class="mr-1 fas fa-calendar"></i> Đặt ngày: @order.InvoiceDate.ToString("dd/MM/yyyy HH:mm")
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Tổng tiền</p>
                        <p class="text-xl font-bold text-brand-600 dark:text-brand-400">
                            @order.TotalAmount.ToString("N0") ₫
                        </p>
                    </div>
                </div>

                <!-- Order Items Preview -->
                @if (order.InvoiceDetails?.Any() == true)
                {
                    <div class="py-4 border-t border-gray-200 dark:border-gray-700">
                        @foreach (var item in order.InvoiceDetails.Take(2))
                        {
                            <div class="flex items-center gap-4 mb-3">
                                @if (item.Variant?.Product?.Images?.Any() == true)
                                {
                                    <img src="@item.Variant.Product.Images.First().ImageUrl" 
                                         alt="@item.Variant.Product.ProductName"
                                         class="object-cover w-16 h-16 border border-gray-200 rounded-lg dark:border-gray-700">
                                }
                                else
                                {
                                    <div class="flex items-center justify-center w-16 h-16 bg-gray-100 rounded-lg dark:bg-gray-800">
                                        <i class="text-2xl text-gray-400 fas fa-image"></i>
                                    </div>
                                }
                                <div class="flex-1">
                                    <h4 class="font-medium text-gray-900 dark:text-white">@item.Variant?.Product?.ProductName</h4>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">@item.Variant?.VariantName</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-gray-900 dark:text-white">@((item.UnitPrice * item.Quantity).ToString("N0")) ₫</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">x@item.Quantity</p>
                                </div>
                            </div>
                        }
                        @if (order.InvoiceDetails.Count() > 2)
                        {
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                Và @(order.InvoiceDetails.Count() - 2) sản phẩm khác...
                            </p>
                        }
                    </div>
                }

                <!-- Order Actions -->
                <div class="flex justify-end gap-2 pt-4 border-t border-gray-200 dark:border-gray-700">
                    <a asp-action="Details" asp-route-id="@order.InvoiceId" 
                       class="px-4 py-2 text-sm font-medium text-gray-700 transition-colors bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">
                        <i class="mr-1 fas fa-eye"></i> Chi tiết
                    </a>
                    <button onclick="reOrder(@order.InvoiceId)" 
                            class="px-4 py-2 text-sm font-medium text-white transition-colors rounded-lg bg-brand-600 hover:bg-brand-700">
                        <i class="mr-1 fas fa-redo"></i> Mua lại
                    </button>
                </div>
            </div>
        }
    }
    else
    {
        <!-- Empty State -->
        <div class="flex flex-col items-center justify-center py-16 bg-white border border-gray-200 rounded-lg dark:bg-gray-900 dark:border-gray-800">
            <div class="flex items-center justify-center w-20 h-20 mb-4 bg-gray-100 rounded-full dark:bg-gray-800">
                <i class="text-4xl text-gray-400 fas fa-receipt"></i>
            </div>
            <h3 class="mb-2 text-xl font-semibold text-gray-900 dark:text-white">
                Chưa có đơn hàng nào
            </h3>
            <p class="mb-6 text-gray-500 dark:text-gray-400">
                Bạn chưa có đơn hàng nào. Hãy bắt đầu mua sắm ngay!
            </p>
            <a asp-area="" asp-controller="Home" asp-action="Index" 
               class="inline-flex items-center gap-2 px-6 py-3 text-white transition-colors rounded-lg bg-brand-600 hover:bg-brand-700">
                <i class="fas fa-shopping-bag"></i>
                <span>Khám phá sản phẩm</span>
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        function reOrder(invoiceId) {
            if (!confirm('Bạn có muốn thêm lại các sản phẩm từ đơn hàng này vào giỏ hàng?')) {
                return;
            }

            $.ajax({
                url: '@Url.Action("ReOrder", "Orders")',
                type: 'POST',
                data: { 
                    id: invoiceId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        if (response.redirectUrl) {
                            window.location.href = response.redirectUrl;
                        }
                    } else {
                        alert(response.message || 'Có lỗi xảy ra!');
                    }
                },
                error: function() {
                    alert('Có lỗi xảy ra khi thêm vào giỏ hàng!');
                }
            });
        }
    </script>
}
