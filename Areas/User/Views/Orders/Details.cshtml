@using MyProject.Areas.Admin.Models
@model MyProject.Areas.User.Models.Invoice

@{
    ViewData["Title"] = "Chi tiết đơn hàng";
    var status = Model.Status;
    var statusText = status.ToDisplayText();
    var statusColor = status.ToColorClass();
    var statusIcon = status.ToIconClass();
}

<div id="order-details-container">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center gap-3 mb-4">
            <a asp-action="Index" class="flex items-center justify-center w-10 h-10 text-gray-700 transition-colors rounded-lg hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-800">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
                    Chi tiết đơn hàng #@Model.InvoiceId
                </h1>
                <p class="mt-1 text-gray-600 dark:text-gray-400">
                    Đặt ngày @Model.CreatedAt.ToString("dd/MM/yyyy") lúc @Model.CreatedAt.ToString("HH:mm")
                </p>
            </div>
        </div>

        <!-- Order Status -->
        <div class="p-4 border-l-4 rounded-lg bg-@(statusColor)-50 border-@(statusColor)-500 dark:bg-@(statusColor)-900/20">
            <div class="flex items-center gap-3">
                <i class="text-2xl text-@(statusColor)-600 @statusIcon dark:text-@(statusColor)-400"></i>
                <div>
                    <p class="font-semibold text-@(statusColor)-800 dark:text-@(statusColor)-400">@statusText</p>
                    <p class="text-sm text-@(statusColor)-700 dark:text-@(statusColor)-500">
                        @if (status == OrderStatus.Pending) { <text>Đơn hàng của bạn đang chờ được xác nhận</text> }
                        else if (status == OrderStatus.Confirmed) { <text>Đơn hàng đã được xác nhận và đang chuẩn bị</text> }
                        else if (status == OrderStatus.Shipped) { <text>Đơn hàng đang được vận chuyển đến bạn</text> }
                        else if (status == OrderStatus.Completed) { <text>Đơn hàng đã hoàn thành</text> }
                        else if (status == OrderStatus.Cancelled) { <text>Đơn hàng đã bị hủy. Lý do: @Model.CancelReason</text> }
                        else if (status == OrderStatus.CancelRequested) { <text>Bạn đã gửi yêu cầu hủy đơn hàng</text> }
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
        <!-- Order Details -->
        <div class="lg:col-span-2">
            <!-- Order Timeline -->
            <div class="p-6 mb-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-900 dark:border-gray-800">
                <h2 class="mb-6 text-xl font-semibold text-gray-900 dark:text-white">
                    <i class="mr-2 fas fa-history text-brand-600"></i>
                    Trạng thái đơn hàng
                </h2>

                <div class="relative space-y-8">
                    @{
                        var steps = new[]
                        {
                            new { Title = "Đơn hàng đã đặt", Date = Model.CreatedAt.ToString("dd/MM/yyyy HH:mm"), IsActive = true, IsCompleted = true },
                            new { Title = "Đã xác nhận", Date = Model.ConfirmedAt?.ToString("dd/MM/yyyy HH:mm"), IsActive = status >= OrderStatus.Confirmed && status != OrderStatus.Cancelled && status != OrderStatus.CancelRequested, IsCompleted = status >= OrderStatus.Confirmed && status != OrderStatus.Cancelled && status != OrderStatus.CancelRequested },
                            new { Title = "Đang giao hàng", Date = Model.ShippedAt?.ToString("dd/MM/yyyy HH:mm"), IsActive = status >= OrderStatus.Shipped && status != OrderStatus.Cancelled && status != OrderStatus.CancelRequested, IsCompleted = status >= OrderStatus.Shipped && status != OrderStatus.Cancelled && status != OrderStatus.CancelRequested },
                            new { Title = "Hoàn thành", Date = Model.CompletedAt?.ToString("dd/MM/yyyy HH:mm"), IsActive = status == OrderStatus.Completed, IsCompleted = status == OrderStatus.Completed }
                        };
                    }

                    @for (int i = 0; i < steps.Length; i++)
                    {
                        var step = steps[i];
                        var isLast = i == steps.Length - 1;
                        
                        <div class="relative flex gap-4">
                            <div class="flex flex-col items-center">
                                <div class="flex items-center justify-center w-10 h-10 rounded-full @(step.IsCompleted || step.IsActive ? "bg-brand-600 text-white" : "bg-gray-200 text-gray-400 dark:bg-gray-700")">
                                    <i class="fas @(step.IsCompleted ? "fa-check" : "fa-circle")"></i>
                                </div>
                                @if (!isLast)
                                {
                                    <div class="w-0.5 h-full mt-2 @(step.IsCompleted ? "bg-brand-600" : "bg-gray-200 dark:bg-gray-700")"></div>
                                }
                            </div>
                            <div class="flex-1 pb-8">
                                <p class="font-semibold @(step.IsActive || step.IsCompleted ? "text-gray-900 dark:text-white" : "text-gray-500 dark:text-gray-400")">@step.Title</p>
                                @if (!string.IsNullOrEmpty(step.Date))
                                {
                                    <p class="text-sm text-gray-500 dark:text-gray-400">@step.Date</p>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Order Items -->
            <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-900 dark:border-gray-800">
                <h2 class="mb-6 text-xl font-semibold text-gray-900 dark:text-white">
                    <i class="mr-2 fas fa-box text-brand-600"></i>
                    Sản phẩm trong đơn hàng
                </h2>

                <div class="space-y-4">
                    @foreach (var item in Model.InvoiceDetails)
                    {
                        <div class="flex gap-4 p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                            <div class="flex items-center justify-center w-20 h-20 overflow-hidden bg-gray-100 rounded-lg dark:bg-gray-800">
                                @if (item.Variant?.Product?.Images?.Any() == true)
                                {
                                    <img src="@item.Variant.Product.Images.First().ImageUrl" class="object-cover w-full h-full" alt="@item.Variant.Product.ProductName">
                                }
                                else
                                {
                                    <i class="text-3xl text-gray-400 fas fa-image"></i>
                                }
                            </div>
                            <div class="flex-1">
                                <h4 class="mb-1 font-semibold text-gray-900 dark:text-white">
                                    @(item.Variant?.Product?.ProductName ?? "Sản phẩm không tồn tại")
                                </h4>
                                <p class="mb-2 text-sm text-gray-500 dark:text-gray-400">
                                    @(item.Variant?.VariantName)
                                </p>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Số lượng: @item.Quantity</span>
                                    <span class="font-semibold text-brand-600 dark:text-brand-400">
                                        @((item.UnitPrice * item.Quantity).ToString("N0")) ₫
                                    </span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="lg:col-span-1">
            <!-- Order Summary -->
            <div class="p-6 mb-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-900 dark:border-gray-800">
                <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">
                    <i class="mr-2 fas fa-file-invoice text-brand-600"></i>
                    Tổng đơn hàng
                </h2>

                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Tạm tính</span>
                        <span class="font-medium text-gray-900 dark:text-white">@Model.TotalAmount.ToString("N0") ₫</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Phí vận chuyển</span>
                        <span class="font-medium text-green-600 dark:text-green-400">Miễn phí</span>
                    </div>
                    <div class="pt-3 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between">
                            <span class="text-lg font-semibold text-gray-900 dark:text-white">Tổng cộng</span>
                            <span class="text-xl font-bold text-brand-600 dark:text-brand-400">@Model.TotalAmount.ToString("N0") ₫</span>
                        </div>
                    </div>
                </div>

                <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                    <p class="mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Phương thức thanh toán</p>
                    <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg dark:bg-gray-800">
                        <i class="text-brand-600 fas fa-credit-card dark:text-brand-400"></i>
                        <span class="text-sm text-gray-900 dark:text-white">
                            @(Model.PayMethod == MyProject.Areas.User.Models.PayMethod.Cash ? "Thanh toán khi nhận hàng (COD)" : "Chuyển khoản ngân hàng")
                        </span>
                    </div>
                </div>
            </div>

            <!-- Shipping Info -->
            <div class="p-6 mb-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-900 dark:border-gray-800">
                <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">
                    <i class="mr-2 fas fa-shipping-fast text-brand-600"></i>
                    Thông tin giao hàng
                </h2>

                <div class="space-y-3 text-sm">
                    <div>
                        <p class="mb-1 font-medium text-gray-700 dark:text-gray-300">Người nhận</p>
                        <p class="text-gray-600 dark:text-gray-400">@Model.RecipientName</p>
                    </div>
                    <div>
                        <p class="mb-1 font-medium text-gray-700 dark:text-gray-300">Số điện thoại</p>
                        <p class="text-gray-600 dark:text-gray-400">@Model.PhoneNumber</p>
                    </div>
                    <div>
                        <p class="mb-1 font-medium text-gray-700 dark:text-gray-300">Địa chỉ</p>
                        <p class="text-gray-600 dark:text-gray-400">@Model.DeliveryAddress</p>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Note))
                    {
                        <div>
                            <p class="mb-1 font-medium text-gray-700 dark:text-gray-300">Ghi chú</p>
                            <p class="text-gray-600 dark:text-gray-400">@Model.Note</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Actions -->
            <div class="space-y-3">
                @if (status == OrderStatus.Shipped)
                {
                    <button onclick="completeOrder(@Model.InvoiceId)"
                            class="flex items-center justify-center w-full gap-2 px-4 py-3 text-white transition-colors bg-green-600 rounded-lg hover:bg-green-700">
                        <i class="fas fa-check"></i>
                        <span>Đã nhận được hàng</span>
                    </button>
                }

                <button onclick="reOrder(@Model.InvoiceId)"
                        class="flex items-center justify-center w-full gap-2 px-4 py-3 text-white transition-colors rounded-lg bg-brand-600 hover:bg-brand-700">
                    <i class="fas fa-redo"></i>
                    <span>Mua lại</span>
                </button>

                @if (status == OrderStatus.Pending || status == OrderStatus.Confirmed)
                {
                    <button onclick="requestCancel(@Model.InvoiceId)"
                            class="flex items-center justify-center w-full gap-2 px-4 py-3 text-red-600 transition-colors bg-white border border-red-600 rounded-lg hover:bg-red-50 dark:bg-gray-900 dark:hover:bg-red-900/20">
                        <i class="fas fa-ban"></i>
                        <span>Yêu cầu hủy</span>
                    </button>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        function reloadPageContent() {
            $('#order-details-container').load(location.href + ' #order-details-container > *', function() {
                // Re-initialize any plugins if needed
            });
        }

        function reOrder(id) {
            $.ajax({
                url: '@Url.Action("ReOrder", "Orders")',
                type: 'POST',
                data: { id: id, __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() },
                success: function(response) {
                    if (response.success) {
                        if (response.redirectUrl) {
                            window.location.href = response.redirectUrl;
                        } else {
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công',
                                text: response.message,
                                timer: 1500,
                                showConfirmButton: false
                            });
                        }
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: response.message
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Có lỗi xảy ra!'
                    });
                }
            });
        }

        function requestCancel(id) {
            Swal.fire({
                title: 'Yêu cầu hủy đơn hàng',
                input: 'textarea',
                inputLabel: 'Lý do hủy',
                inputPlaceholder: 'Nhập lý do hủy đơn hàng...',
                inputAttributes: {
                    'aria-label': 'Nhập lý do hủy đơn hàng'
                },
                showCancelButton: true,
                confirmButtonText: 'Gửi yêu cầu',
                cancelButtonText: 'Đóng',
                confirmButtonColor: '#d33',
                showLoaderOnConfirm: true,
                preConfirm: (reason) => {
                    if (!reason) {
                        Swal.showValidationMessage('Vui lòng nhập lý do');
                        return false;
                    }
                    return $.ajax({
                        url: '@Url.Action("RequestCancel", "Orders")',
                        type: 'POST',
                        data: { id: id, reason: reason, __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() }
                    }).then(response => {
                        if (!response.success) {
                            throw new Error(response.message || 'Có lỗi xảy ra');
                        }
                        return response;
                    }).catch(error => {
                        Swal.showValidationMessage(
                            `Request failed: ${error}`
                        );
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Đã gửi yêu cầu!',
                        text: result.value.message,
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        reloadPageContent();
                    });
                }
            });
        }

        function completeOrder(id) {
            Swal.fire({
                title: 'Xác nhận đã nhận hàng?',
                text: "Bạn xác nhận đã nhận được hàng và muốn hoàn thành đơn hàng?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10B981',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Đúng, tôi đã nhận hàng',
                cancelButtonText: 'Hủy'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("CompleteOrder", "Invoice", new { area = "Admin" })',
                        type: 'POST',
                        data: { invoiceId: id },
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Hoàn thành!',
                                    text: response.message,
                                    timer: 1500,
                                    showConfirmButton: false
                                }).then(() => {
                                    reloadPageContent();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Lỗi',
                                    text: response.message
                                });
                            }
                        },
                        error: function() {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi',
                                text: 'Có lỗi xảy ra!'
                            });
                        }
                    });
                }
            });
        }
    </script>
}
