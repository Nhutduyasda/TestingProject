@model MyProject.Areas.Admin.Models.User
@{
    ViewData["Title"] = "Hồ sơ của tôi";
}

<!-- Page Header -->
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
        <i class="mr-2 fas fa-user text-brand-600"></i>
        Hồ sơ của tôi
    </h1>
    <p class="mt-2 text-gray-600 dark:text-gray-400">
        Quản lý thông tin cá nhân và cài đặt tài khoản
    </p>
</div>

<div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
    <!-- Profile Sidebar -->
    <div class="lg:col-span-1">
        <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-900 dark:border-gray-800">
            <!-- Profile Picture -->
            <div class="mb-6 text-center">
                <div class="inline-flex items-center justify-center w-24 h-24 mb-4 text-3xl font-bold text-white rounded-full bg-gradient-to-br from-brand-500 to-brand-600">
                    @(User.Identity?.Name?.Substring(0, 1).ToUpper())
                </div>
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                    @User.Identity?.Name
                </h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    @User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value
                </p>
            </div>

            <!-- Stats -->
            <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Thành viên từ</span>
                        <span class="text-sm font-medium text-gray-900 dark:text-white">@DateTime.Now.ToString("MM/yyyy")</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Tổng đơn hàng</span>
                        <span class="text-sm font-medium text-gray-900 dark:text-white">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600 dark:text-gray-400">Điểm tích lũy</span>
                        <span class="text-sm font-medium text-brand-600 dark:text-brand-400">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Forms -->
    <div class="lg:col-span-2">
        <div class="space-y-6">
            <!-- Personal Information -->
            <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-900 dark:border-gray-800">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
                        <i class="mr-2 fas fa-user-edit text-brand-600"></i>
                        Thông tin cá nhân
                    </h2>
                    <button type="button" onclick="updateProfile()" class="px-4 py-2 text-sm text-white transition-colors rounded-lg bg-brand-600 hover:bg-brand-700">
                        <i class="mr-1 fas fa-save"></i> Lưu thay đổi
                    </button>
                </div>

                <form class="space-y-4" id="profileForm">
                    @Html.AntiForgeryToken()
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Họ (Last Name)
                            </label>
                            <input type="text" id="lastName" value="@Model?.LastName" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Tên đệm & Tên (First Name)
                            </label>
                            <input type="text" id="firstName" value="@Model?.FirstMidName" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Email
                            </label>
                            <input type="email" value="@Model?.Email" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white" readonly>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Số điện thoại
                            </label>
                            <input type="tel" id="phoneNumber" value="@Model?.PhoneNumber" placeholder="Nhập số điện thoại" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                        </div>
                    </div>

                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Địa chỉ
                        </label>
                        <textarea rows="3" id="address" placeholder="Nhập địa chỉ của bạn" 
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">@Model?.Address</textarea>
                    </div>
                </form>
            </div>

            <!-- Change Password -->
            <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-900 dark:border-gray-800">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">
                        <i class="mr-2 fas fa-lock text-brand-600"></i>
                        Đổi mật khẩu
                    </h2>
                </div>

                <form class="space-y-4" id="passwordForm">
                    <div>
                        <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                            Mật khẩu hiện tại
                        </label>
                        <input type="password" id="currentPassword" placeholder="Nhập mật khẩu hiện tại" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                    </div>

                    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Mật khẩu mới
                            </label>
                            <input type="password" id="newPassword" placeholder="Nhập mật khẩu mới" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                                Xác nhận mật khẩu
                            </label>
                            <input type="password" id="confirmPassword" placeholder="Nhập lại mật khẩu mới" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button type="button" onclick="changePassword()" class="px-4 py-2 text-sm text-white transition-colors rounded-lg bg-brand-600 hover:bg-brand-700">
                            <i class="mr-1 fas fa-key"></i> Đổi mật khẩu
                        </button>
                    </div>
                </form>
            </div>

            <!-- Notification Settings -->
            <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-sm dark:bg-gray-900 dark:border-gray-800">
                <h2 class="mb-6 text-xl font-semibold text-gray-900 dark:text-white">
                    <i class="mr-2 fas fa-bell text-brand-600"></i>
                    Cài đặt thông báo
                </h2>

                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">Email về đơn hàng</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Nhận thông báo về trạng thái đơn hàng</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" checked class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-300 dark:peer-focus:ring-brand-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-brand-600"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">Email khuyến mãi</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Nhận thông tin về ưu đãi và sản phẩm mới</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" checked class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-300 dark:peer-focus:ring-brand-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-brand-600"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg dark:border-gray-700">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">SMS thông báo</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Nhận SMS về đơn hàng và giao hàng</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-brand-300 dark:peer-focus:ring-brand-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-brand-600"></div>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed z-50 flex flex-col gap-2 top-4 right-4"></div>

@section Scripts {
    @{await Html.RenderPartialAsync("~/Areas/Admin/Views/Shared/_ModernValidationScripts.cshtml");}
    
    <script>
        // Toast Notification System
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            // Icons based on type
            const icon = type === 'success' 
                ? '<i class="text-green-500 fas fa-check-circle text-xl"></i>' 
                : '<i class="text-red-500 fas fa-exclamation-circle text-xl"></i>';
                
            const borderClass = type === 'success' ? 'border-green-500' : 'border-red-500';
            const bgClass = type === 'success' ? 'bg-white dark:bg-gray-800' : 'bg-white dark:bg-gray-800';
            
            toast.className = `flex items-center gap-3 p-4 mb-2 min-w-[300px] border-l-4 ${borderClass} ${bgClass} rounded shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.innerHTML = `
                ${icon}
                <div class="flex-1">
                    <p class="font-medium text-gray-900 dark:text-white">${type === 'success' ? 'Thành công' : 'Lỗi'}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Slide in animation
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full');
            });
            
            // Auto dismiss
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        function updateProfile() {
            const data = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                address: document.getElementById('address').value
            };

            // Basic validation
            if (!data.firstName || !data.lastName) {
                showToast('Vui lòng nhập đầy đủ họ tên', 'error');
                return;
            }

            // Get AntiForgeryToken
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            fetch('/User/Profile/UpdateProfile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast(result.message, 'success');
                    // Optional: reload to refresh server-side data if needed, 
                    // or just update UI if simple. For now, let's keep reload to be safe.
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Có lỗi xảy ra khi cập nhật thông tin', 'error');
            });
        }

        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Client-side Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Vui lòng điền đầy đủ thông tin', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showToast('Mật khẩu mới phải có ít nhất 6 ký tự', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('Mật khẩu xác nhận không khớp', 'error');
                return;
            }

            const data = {
                currentPassword: currentPassword,
                newPassword: newPassword,
                confirmPassword: confirmPassword
            };

            // Get AntiForgeryToken
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            fetch('/User/Profile/ChangePassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': token
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast(result.message, 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    showToast(result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Có lỗi xảy ra khi đổi mật khẩu', 'error');
            });
        }
    </script>
}
