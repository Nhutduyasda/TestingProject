@model MyProject.Models.Shared.Product

@{
    ViewData["Title"] = Model.ProductName;
    var relatedProducts = ViewBag.RelatedProducts as List<MyProject.Models.Shared.Product>;
    var minPrice = Model.Variants?.Any() == true ? Model.Variants.Min(v => v.Price) : 0;
    var maxPrice = Model.Variants?.Any() == true ? Model.Variants.Max(v => v.Price) : 0;
}

<!-- Breadcrumb -->
<div class="py-4 bg-gray-50 dark:bg-gray-900">
    <div class="px-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
        <nav class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
            <a asp-controller="Home" asp-action="Index" class="hover:text-brand-600">
                <i class="fas fa-home"></i> Trang chủ
            </a>
            <i class="fas fa-chevron-right"></i>
            <a asp-action="Index" class="hover:text-brand-600">Sản phẩm</a>
            <i class="fas fa-chevron-right"></i>
            <span class="text-gray-900 dark:text-white">@Model.ProductName</span>
        </nav>
    </div>
</div>

<!-- Product Details -->
<div class="py-12 bg-white dark:bg-gray-950">
    <div class="px-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
            
            <!-- Product Images -->
            <div>
                <div class="mb-4 overflow-hidden bg-gray-100 rounded-lg dark:bg-gray-800" x-data="{ activeImage: '@(Model.Images?.FirstOrDefault()?.ImageUrl ?? "/images/no-image.jpg")' }">
                    <img :src="activeImage" 
                         alt="@Model.ProductName"
                         class="object-cover w-full h-full aspect-square">
                </div>

                @if (Model.Images?.Count > 1)
                {
                    <div class="grid grid-cols-4 gap-4">
                        @foreach (var image in Model.Images)
                        {
                            <button @@click="activeImage = '@image.ImageUrl'" 
                                    class="overflow-hidden transition-all border-2 rounded-lg hover:border-brand-600"
                                    :class="activeImage === '@image.ImageUrl' ? 'border-brand-600' : 'border-gray-200 dark:border-gray-700'">
                                <img src="@image.ImageUrl" 
                                     alt="@Model.ProductName"
                                     class="object-cover w-full h-full aspect-square">
                            </button>
                        }
                    </div>
                }
            </div>

            <!-- Product Info -->
            <div>
                <h1 class="mb-4 text-3xl font-bold text-gray-900 dark:text-white">
                    @Model.ProductName
                </h1>

                <!-- Rating & Reviews -->
                @if (Model.ReviewCount > 0)
                {
                    <div class="flex items-center gap-4 pb-4 mb-4 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center gap-2">
                            <div class="flex items-center gap-1">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    if (i <= Math.Floor(Model.AverageRating))
                                    {
                                        <i class="text-yellow-400 fas fa-star"></i>
                                    }
                                    else if (i - 0.5 <= Model.AverageRating)
                                    {
                                        <i class="text-yellow-400 fas fa-star-half-alt"></i>
                                    }
                                    else
                                    {
                                        <i class="text-gray-300 far fa-star"></i>
                                    }
                                }
                            </div>
                            <span class="text-lg font-semibold text-gray-900 dark:text-white">
                                @Model.AverageRating.ToString("0.0")
                            </span>
                        </div>
                        <a href="#reviews" class="text-brand-600 hover:underline">
                            (@Model.ReviewCount đánh giá)
                        </a>
                    </div>
                }

                <!-- Price -->
                <div class="pb-4 mb-4 border-b border-gray-200 dark:border-gray-700">
                    @if (minPrice == maxPrice)
                    {
                        <p class="text-4xl font-bold text-brand-600 dark:text-brand-400">
                            @minPrice.ToString("N0") ₫
                        </p>
                    }
                    else
                    {
                        <p class="text-3xl font-bold text-brand-600 dark:text-brand-400">
                            @minPrice.ToString("N0") ₫ - @maxPrice.ToString("N0") ₫
                        </p>
                    }
                </div>

                <!-- Category & Supplier -->
                <div class="pb-4 mb-4 space-y-2 border-b border-gray-200 dark:border-gray-700">
                    <p class="text-gray-600 dark:text-gray-400">
                        <span class="font-semibold">Danh mục:</span> 
                        <span class="text-brand-600">@Model.Category?.CategoryName</span>
                    </p>
                    <p class="text-gray-600 dark:text-gray-400">
                        <span class="font-semibold">Nhà cung cấp:</span> 
                        <span>@Model.Supplier?.SupplierName</span>
                    </p>
                </div>

                <!-- Description -->
                @if (!string.IsNullOrWhiteSpace(Model.Description))
                {
                    <div class="pb-4 mb-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="mb-2 text-lg font-semibold text-gray-900 dark:text-white">Mô tả</h3>
                        <p class="text-gray-600 dark:text-gray-400">@Model.Description</p>
                    </div>
                }

                <!-- Variants -->
                @if (Model.Variants?.Any() == true)
                {
                    <div class="mb-6" x-data="{ selectedVariant: null }">
                        <h3 class="mb-3 text-lg font-semibold text-gray-900 dark:text-white">
                            Chọn phiên bản
                        </h3>

                        <div class="space-y-2">
                            @foreach (var variant in Model.Variants)
                            {
                                var isAvailable = variant.Quanlity > 0;
                                var attributes = variant.VariantAttributes?.Select(va => va.Value).ToList();
                                var attributesText = attributes?.Any() == true ? string.Join(" | ", attributes) : variant.VariantName;

                                <button @@click="selectedVariant = @variant.VariantId" 
                                        class="flex items-center justify-between w-full p-4 text-left transition-all border-2 rounded-lg @(isAvailable ? "hover:border-brand-600" : "opacity-50 cursor-not-allowed")"
                                        :class="selectedVariant === @variant.VariantId ? 'border-brand-600 bg-brand-50 dark:bg-brand-900/10' : 'border-gray-200 dark:border-gray-700'"
                                        disabled="@(!isAvailable)">
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-900 dark:text-white">
                                            @attributesText
                                        </p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">
                                            @(isAvailable ? $"Còn {variant.Quanlity} sản phẩm" : "Hết hàng")
                                        </p>
                                    </div>
                                    <p class="text-xl font-bold text-brand-600 dark:text-brand-400">
                                        @variant.Price.ToString("N0") ₫
                                    </p>
                                </button>
                            }
                        </div>

                        <!-- Add to Cart Button -->
                        <div class="mt-6 space-y-3">
                            <button @@click="addToCart()" 
                                    x-bind:disabled="!selectedVariant"
                                    class="w-full px-8 py-4 text-lg font-semibold text-white transition-colors rounded-lg disabled:opacity-50 disabled:cursor-not-allowed bg-brand-600 hover:bg-brand-700">
                                <i class="mr-2 fas fa-shopping-cart"></i>
                                Thêm vào giỏ hàng
                            </button>
                            <button class="w-full px-8 py-4 text-lg font-semibold text-gray-700 transition-colors bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700">
                                <i class="mr-2 far fa-heart"></i>
                                Thêm vào yêu thích
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Reviews Section -->
<div id="reviews" class="py-12 bg-gray-50 dark:bg-gray-900">
    <div class="px-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
        <h2 class="mb-8 text-2xl font-bold text-gray-900 dark:text-white">
            Đánh giá sản phẩm (@Model.ReviewCount)
        </h2>

        @if (Model.Reviews?.Any() == true)
        {
            <div class="space-y-4">
                @foreach (var review in Model.Reviews.OrderByDescending(r => r.CreatedAt))
                {
                    <div class="p-6 bg-white rounded-lg shadow-sm dark:bg-gray-800">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white">
                                    @(review.User != null ? $"{review.User.FirstMidName} {review.User.LastName}" : "Người dùng")
                                </p>
                                <div class="flex items-center gap-1 mt-1">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="@(i <= review.Rating ? "fas text-yellow-400" : "far text-gray-300") fa-star"></i>
                                    }
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                @review.CreatedAt.ToString("dd/MM/yyyy")
                            </p>
                        </div>
                        <p class="text-gray-700 dark:text-gray-300">@review.ReviewText</p>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="py-12 text-center">
                <div class="flex items-center justify-center w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full dark:bg-gray-800">
                    <i class="text-4xl text-gray-400 far fa-comment"></i>
                </div>
                <p class="text-gray-500 dark:text-gray-400">Chưa có đánh giá nào cho sản phẩm này</p>
            </div>
        }
    </div>
</div>

<!-- Related Products -->
@if (relatedProducts?.Any() == true)
{
    <div class="py-12 bg-white dark:bg-gray-950">
        <div class="px-4 mx-auto max-w-7xl sm:px-6 lg:px-8">
            <h2 class="mb-8 text-2xl font-bold text-gray-900 dark:text-white">
                Sản phẩm liên quan
            </h2>

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
                @foreach (var product in relatedProducts)
                {
                    var productMinPrice = product.Variants?.Any() == true ? product.Variants.Min(v => v.Price) : 0;
                    var imageUrl = product.Images?.FirstOrDefault()?.ImageUrl ?? "/images/no-image.jpg";
                    var inStock = product.Variants?.Any(v => v.Quanlity > 0) ?? false;

                    <div class="overflow-hidden transition-shadow duration-300 bg-white rounded-lg shadow-sm group dark:bg-gray-800 hover:shadow-lg">
                        <a asp-action="Details" asp-route-id="@product.ProductId" class="block">
                            <div class="relative overflow-hidden aspect-square">
                                <img src="@imageUrl" 
                                     alt="@product.ProductName"
                                     class="object-cover w-full h-full transition-transform duration-300 group-hover:scale-110">
                                
                                @if (product.ReviewCount > 0)
                                {
                                    <div class="absolute flex items-center gap-1 px-2 py-1 text-sm font-semibold text-yellow-900 bg-yellow-400 rounded-full top-3 left-3">
                                        <i class="fas fa-star"></i>
                                        <span>@product.AverageRating.ToString("0.0")</span>
                                    </div>
                                }
                            </div>

                            <div class="p-4">
                                <h3 class="mb-2 text-lg font-semibold text-gray-900 line-clamp-2 dark:text-white group-hover:text-brand-600">
                                    @product.ProductName
                                </h3>

                                <p class="text-xl font-bold text-brand-600 dark:text-brand-400">
                                    @productMinPrice.ToString("N0") ₫
                                </p>
                            </div>
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        function addToCart() {
            const selectedVariant = Alpine.store('selectedVariant') || document.querySelector('[x-data] button[class*="border-brand-600"]')?.getAttribute('@@click')?.match(/\d+/)?.[0];
            
            if (!selectedVariant) {
                showToast('Vui lòng chọn phiên bản sản phẩm!', 'error');
                return;
            }

            $.ajax({
                url: '@Url.Action("AddToCart", "Cart")',
                type: 'POST',
                data: { 
                    variantId: selectedVariant,
                    quantity: 1,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        showToast('Đã thêm sản phẩm vào giỏ hàng!', 'success');
                        // Update cart count in navbar if exists
                        const cartCount = document.querySelector('#cartCount');
                        if (cartCount && response.cartCount) {
                            cartCount.textContent = response.cartCount;
                        }
                    } else {
                        showToast(response.message || 'Có lỗi xảy ra!', 'error');
                    }
                },
                error: function() {
                    showToast('Có lỗi xảy ra khi thêm vào giỏ hàng!', 'error');
                }
            });
        }
    </script>
}
