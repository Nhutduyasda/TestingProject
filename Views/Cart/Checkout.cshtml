@model MyProject.Areas.User.Models.Cart

@{
    ViewData["Title"] = "Thanh toán";
    var cartDetails = ViewBag.CartDetails as IEnumerable<MyProject.Areas.User.Models.CartDetail>;
    var totalPrice = ViewBag.TotalPrice ?? 0m;
    var totalItems = ViewBag.TotalItems ?? 0;
    var user = ViewBag.User as MyProject.Areas.Admin.Models.User; // Assuming we might pass user info, or we can use User.Identity
}

<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
        <i class="mr-2 fas fa-credit-card text-brand-600"></i>
        Thanh toán
    </h1>
    <p class="mt-2 text-gray-600 dark:text-gray-400">
        Hoàn tất đơn hàng của bạn
    </p>
</div>

<form id="checkoutForm" class="grid grid-cols-1 gap-8 lg:grid-cols-3">
    <!-- Left Column: Shipping & Payment -->
    <div class="space-y-8 lg:col-span-2">
        
        <!-- Shipping Information -->
        <div class="p-6 bg-white border border-gray-200 rounded-xl shadow-sm dark:bg-gray-900 dark:border-gray-800">
            <h2 class="mb-6 text-xl font-semibold text-gray-900 dark:text-white">
                <i class="mr-2 fas fa-map-marker-alt text-brand-600"></i>
                Thông tin giao hàng
            </h2>
            
            <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <div class="col-span-2">
                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Họ và tên</label>
                    <input type="text" name="fullName" value="@User.Identity?.Name" required
                           class="w-full px-4 py-3 transition-colors border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                </div>
                
                <div>
                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Số điện thoại</label>
                    <input type="tel" name="phoneNumber" required
                           class="w-full px-4 py-3 transition-colors border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                </div>
                
                <div>
                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                    <input type="email" name="email" value="@User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value" required
                           class="w-full px-4 py-3 transition-colors border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                </div>
                
                <div class="col-span-2">
                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Địa chỉ nhận hàng</label>
                    <input type="text" name="address" required
                           class="w-full px-4 py-3 transition-colors border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                           placeholder="Số nhà, tên đường, phường/xã, quận/huyện, tỉnh/thành phố">
                </div>
                
                <div class="col-span-2">
                    <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">Ghi chú (tùy chọn)</label>
                    <textarea name="note" rows="3"
                              class="w-full px-4 py-3 transition-colors border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 dark:bg-gray-800 dark:border-gray-700 dark:text-white"
                              placeholder="Ghi chú về đơn hàng, ví dụ: thời gian hay chỉ dẫn địa điểm giao hàng chi tiết hơn."></textarea>
                </div>
            </div>
        </div>

        <!-- Payment Method -->
        <div class="p-6 bg-white border border-gray-200 rounded-xl shadow-sm dark:bg-gray-900 dark:border-gray-800">
            <h2 class="mb-6 text-xl font-semibold text-gray-900 dark:text-white">
                <i class="mr-2 fas fa-wallet text-brand-600"></i>
                Phương thức thanh toán
            </h2>
            
            <div class="space-y-4" x-data="{ paymentMethod: 'Cash' }">
                <!-- COD -->
                <label class="relative flex items-center p-4 transition-all border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800"
                       :class="paymentMethod === 'Cash' ? 'border-brand-600 ring-1 ring-brand-600 bg-brand-50 dark:bg-brand-900/10' : 'border-gray-200 dark:border-gray-700'">
                    <input type="radio" name="payMethod" value="Cash" class="hidden" x-model="paymentMethod">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center justify-center w-10 h-10 text-green-600 bg-green-100 rounded-full dark:bg-green-900/20 dark:text-green-400">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900 dark:text-white">Thanh toán khi nhận hàng (COD)</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Thanh toán bằng tiền mặt khi giao hàng</p>
                        </div>
                    </div>
                    <div class="absolute right-4" x-show="paymentMethod === 'Cash'">
                        <i class="text-xl text-brand-600 fas fa-check-circle"></i>
                    </div>
                </label>

                <!-- Banking -->
                <label class="relative flex items-center p-4 transition-all border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800"
                       :class="paymentMethod === 'Banking' ? 'border-brand-600 ring-1 ring-brand-600 bg-brand-50 dark:bg-brand-900/10' : 'border-gray-200 dark:border-gray-700'">
                    <input type="radio" name="payMethod" value="Banking" class="hidden" x-model="paymentMethod">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center justify-center w-10 h-10 text-blue-600 bg-blue-100 rounded-full dark:bg-blue-900/20 dark:text-blue-400">
                            <i class="fas fa-university"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900 dark:text-white">Chuyển khoản ngân hàng</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Quét mã QR hoặc chuyển khoản trực tiếp</p>
                        </div>
                    </div>
                    <div class="absolute right-4" x-show="paymentMethod === 'Banking'">
                        <i class="text-xl text-brand-600 fas fa-check-circle"></i>
                    </div>
                </label>
                
                <!-- Banking Info (Show only if Banking selected) -->
                <div x-show="paymentMethod === 'Banking'" x-collapse class="p-4 mt-4 bg-gray-50 rounded-lg dark:bg-gray-800">
                    <p class="mb-2 text-sm font-semibold text-gray-900 dark:text-white">Thông tin chuyển khoản:</p>
                    <ul class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                        <li>Ngân hàng: <strong>MB Bank</strong></li>
                        <li>Số tài khoản: <strong>000011112222</strong></li>
                        <li>Chủ tài khoản: <strong>MY PROJECT SHOP</strong></li>
                        <li>Nội dung: <strong>[Tên] + [SĐT]</strong></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column: Order Summary -->
    <div class="lg:col-span-1">
        <div class="sticky p-6 bg-white border border-gray-200 shadow-lg top-24 rounded-xl dark:bg-gray-900 dark:border-gray-800">
            <h2 class="mb-6 text-xl font-semibold text-gray-900 dark:text-white">
                Đơn hàng của bạn
            </h2>

            <!-- Items List (Collapsed) -->
            <div class="mb-6 space-y-4 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                @if (cartDetails != null)
                {
                    foreach (var item in cartDetails)
                    {
                        <div class="flex gap-3">
                            <div class="relative flex-shrink-0 w-16 h-16 overflow-hidden border border-gray-200 rounded-md dark:border-gray-700">
                                @if (item.Variant?.Product?.Images?.Any() == true)
                                {
                                    <img src="@item.Variant.Product.Images.First().ImageUrl" 
                                         class="object-cover w-full h-full">
                                }
                                else
                                {
                                    <div class="flex items-center justify-center w-full h-full bg-gray-100 dark:bg-gray-800">
                                        <i class="text-gray-400 fas fa-image"></i>
                                    </div>
                                }
                                <span class="absolute top-0 right-0 flex items-center justify-center w-5 h-5 text-xs text-white transform translate-x-1/2 -translate-y-1/2 rounded-full bg-brand-600">
                                    @item.Quantity
                                </span>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-sm font-medium text-gray-900 line-clamp-2 dark:text-white">
                                    @item.Variant?.Product?.ProductName
                                </h4>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    @item.Variant?.VariantName
                                </p>
                                <p class="text-sm font-semibold text-brand-600 dark:text-brand-400">
                                    @(((item.Variant?.Price ?? 0) * item.Quantity).ToString("N0")) ₫
                                </p>
                            </div>
                        </div>
                    }
                }
            </div>

            <div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-3">
                <div class="flex justify-between text-gray-600 dark:text-gray-400">
                    <span>Tạm tính</span>
                    <span>@totalPrice.ToString("N0") ₫</span>
                </div>
                <div class="flex justify-between text-gray-600 dark:text-gray-400">
                    <span>Phí vận chuyển</span>
                    <span class="text-green-600">Miễn phí</span>
                </div>
                <div class="flex justify-between pt-3 text-lg font-bold border-t border-gray-200 dark:border-gray-700 text-gray-900 dark:text-white">
                    <span>Tổng cộng</span>
                    <span class="text-brand-600">@totalPrice.ToString("N0") ₫</span>
                </div>
            </div>

            <button type="button" onclick="placeOrder()"
                    class="flex items-center justify-center w-full gap-2 px-6 py-4 mt-6 text-lg font-semibold text-white transition-all shadow-lg bg-gradient-to-r from-brand-600 to-purple-600 rounded-xl hover:from-brand-700 hover:to-purple-700 hover:shadow-xl">
                <span>Đặt hàng ngay</span>
                <i class="fas fa-arrow-right"></i>
            </button>

            <p class="mt-4 text-xs text-center text-gray-500 dark:text-gray-400">
                Bằng cách đặt hàng, bạn đồng ý với <a href="#" class="underline hover:text-brand-600">điều khoản sử dụng</a> của chúng tôi.
            </p>
        </div>
    </div>
</form>

@section Scripts {
    <script>
        function placeOrder() {
            const form = document.getElementById('checkoutForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Show loading state
            const btn = document.querySelector('button[onclick="placeOrder()"]');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

            $.ajax({
                url: '@Url.Action("ProcessCheckout", "Cart")',
                type: 'POST',
                data: data,
                success: function(response) {
                    if (response.success) {
                        showToast('Đặt hàng thành công!', 'success');
                        setTimeout(() => {
                            window.location.href = '@Url.Action("OrderSuccess", "Cart")?invoiceId=' + response.invoiceId;
                        }, 1000);
                    } else {
                        showToast(response.message || 'Có lỗi xảy ra!', 'error');
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                },
                error: function() {
                    showToast('Có lỗi xảy ra khi xử lý đơn hàng!', 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            });
        }
    </script>
}
